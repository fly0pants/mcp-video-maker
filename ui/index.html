<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TikTok风格短视频生成系统</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding-top: 20px;
        padding-bottom: 40px;
      }
      .form-section {
        margin-bottom: 30px;
      }
      .status-card {
        margin-top: 20px;
      }
      .hidden {
        display: none;
      }
      .preview-container {
        margin-top: 20px;
      }
      .preview-item {
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .approval-buttons {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">TikTok风格短视频生成系统</h1>

      <!-- 创建视频表单 -->
      <div id="createForm" class="form-section">
        <div class="card">
          <div class="card-header">
            <h3>创建新视频</h3>
          </div>
          <div class="card-body">
            <form id="videoForm">
              <div class="mb-3">
                <label for="theme" class="form-label">视频主题</label>
                <input type="text" class="form-control" id="theme" required />
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="style" class="form-label">视频风格</label>
                  <select class="form-select" id="style" required>
                    <option value="realistic">写实风格</option>
                    <option value="cartoon">卡通风格</option>
                    <option value="anime">动漫风格</option>
                    <option value="cinematic">电影风格</option>
                    <option value="vlog" selected>视频博客风格</option>
                    <option value="vintage">复古风格</option>
                    <option value="futuristic">未来风格</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="scriptType" class="form-label">脚本类型</label>
                  <select class="form-select" id="scriptType" required>
                    <option value="narrative" selected>叙事型</option>
                    <option value="tutorial">教程型</option>
                    <option value="comedy">喜剧型</option>
                    <option value="review">评测型</option>
                    <option value="trending">趋势型</option>
                    <option value="emotional">情感型</option>
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <label for="targetAudience" class="form-label"
                  >目标受众（用逗号分隔）</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="targetAudience"
                  value="年轻人,学生,上班族"
                />
              </div>

              <div class="mb-3">
                <label for="duration" class="form-label">视频时长（秒）</label>
                <input
                  type="number"
                  class="form-control"
                  id="duration"
                  min="10"
                  max="60"
                  value="30"
                />
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="videoModel" class="form-label"
                    >视频生成模型</label
                  >
                  <select class="form-select" id="videoModel">
                    <option value="keling">可灵</option>
                    <option value="pika">Pika</option>
                    <option value="runway">Runway</option>
                    <option value="wan" selected>Wan 2.1</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="voiceTool" class="form-label">语音合成工具</label>
                  <select class="form-select" id="voiceTool">
                    <option value="elevenlabs">ElevenLabs</option>
                    <option value="playht">Play.ht</option>
                    <option value="deepseek_tencent" selected>
                      DeepSeek+腾讯混元
                    </option>
                  </select>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="musicTool" class="form-label">音乐生成工具</label>
                  <select class="form-select" id="musicTool">
                    <option value="suno" selected>Suno AI</option>
                    <option value="aiva">AIVA</option>
                    <option value="soundraw">Soundraw</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="editingTool" class="form-label">编辑工具</label>
                  <select class="form-select" id="editingTool">
                    <option value="runway" selected>Runway</option>
                    <option value="descript">Descript</option>
                    <option value="kapwing">Kapwing</option>
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <label for="keywords" class="form-label"
                  >关键词（用逗号分隔）</label
                >
                <input type="text" class="form-control" id="keywords" />
              </div>

              <div class="mb-3">
                <label for="specialRequirements" class="form-label"
                  >特殊要求</label
                >
                <textarea
                  class="form-control"
                  id="specialRequirements"
                  rows="3"
                ></textarea>
              </div>

              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="includeCaptions"
                  checked
                />
                <label class="form-check-label" for="includeCaptions"
                  >包含字幕</label
                >
              </div>

              <button type="submit" class="btn btn-primary">开始生成</button>
            </form>
          </div>
        </div>
      </div>

      <!-- 状态显示 -->
      <div id="statusSection" class="status-card hidden">
        <div class="card">
          <div class="card-header">
            <h3>视频生成状态</h3>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <strong>会话ID：</strong> <span id="sessionId"></span>
            </div>
            <div class="mb-3">
              <strong>当前状态：</strong> <span id="currentStatus"></span>
            </div>
            <div class="mb-3">
              <strong>开始时间：</strong> <span id="startedAt"></span>
            </div>
            <div class="mb-3">
              <strong>更新时间：</strong> <span id="updatedAt"></span>
            </div>
            <div class="progress mb-3">
              <div
                id="progressBar"
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                0%
              </div>
            </div>
            <button id="cancelBtn" class="btn btn-danger">取消生成</button>
            <button id="refreshBtn" class="btn btn-secondary">刷新状态</button>
          </div>
        </div>
      </div>

      <!-- 预览和审批 -->
      <div id="previewSection" class="preview-container hidden">
        <div class="card">
          <div class="card-header">
            <h3>预览和审批</h3>
          </div>
          <div class="card-body">
            <div id="previewContent"></div>
            <div class="approval-buttons">
              <button id="approveBtn" class="btn btn-success">批准</button>
              <button id="rejectBtn" class="btn btn-warning">拒绝</button>
            </div>
            <div class="mb-3 mt-3">
              <label for="feedbackText" class="form-label">反馈意见</label>
              <textarea
                class="form-control"
                id="feedbackText"
                rows="3"
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- 最终结果 -->
      <div id="resultSection" class="hidden">
        <div class="card">
          <div class="card-header">
            <h3>生成结果</h3>
          </div>
          <div class="card-body">
            <div id="videoResult"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // API基础URL
      const API_BASE_URL = "http://localhost:8000/api";

      // 当前会话ID
      let currentSessionId = null;

      // 当前阶段
      let currentStage = null;

      // 状态轮询定时器
      let statusTimer = null;

      // 表单提交处理
      document
        .getElementById("videoForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // 收集表单数据
          const formData = {
            theme: document.getElementById("theme").value,
            style: document.getElementById("style").value,
            script_type: document.getElementById("scriptType").value,
            target_audience: document
              .getElementById("targetAudience")
              .value.split(",")
              .map((item) => item.trim()),
            duration: parseFloat(document.getElementById("duration").value),
            language: "zh",
            video_model: document.getElementById("videoModel").value,
            voice_tool: document.getElementById("voiceTool").value,
            music_tool: document.getElementById("musicTool").value,
            editing_tool: document.getElementById("editingTool").value,
            keywords: document.getElementById("keywords").value
              ? document
                  .getElementById("keywords")
                  .value.split(",")
                  .map((item) => item.trim())
              : [],
            special_requirements: document.getElementById("specialRequirements")
              .value,
            include_captions:
              document.getElementById("includeCaptions").checked,
            resolution: "1080x1920",
          };

          try {
            // 发送创建请求
            const response = await fetch(`${API_BASE_URL}/videos/create`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (data.success) {
              // 保存会话ID
              currentSessionId = data.session_id;

              // 显示状态区域
              document.getElementById("createForm").classList.add("hidden");
              document
                .getElementById("statusSection")
                .classList.remove("hidden");

              // 更新状态显示
              document.getElementById("sessionId").textContent =
                currentSessionId;

              // 开始轮询状态
              startStatusPolling();
            } else {
              alert("创建失败：" + data.message);
            }
          } catch (error) {
            console.error("Error:", error);
            alert("创建请求失败，请查看控制台了解详情");
          }
        });

      // 开始轮询状态
      function startStatusPolling() {
        // 清除现有定时器
        if (statusTimer) {
          clearInterval(statusTimer);
        }

        // 立即获取一次状态
        getVideoStatus();

        // 设置定时器，每5秒获取一次状态
        statusTimer = setInterval(getVideoStatus, 5000);
      }

      // 获取视频状态
      async function getVideoStatus() {
        if (!currentSessionId) return;

        try {
          const response = await fetch(
            `${API_BASE_URL}/videos/status/${currentSessionId}`
          );
          const data = await response.json();

          if (data.success) {
            // 更新状态显示
            document.getElementById("currentStatus").textContent = data.status;
            document.getElementById("startedAt").textContent = new Date(
              data.started_at
            ).toLocaleString();
            document.getElementById("updatedAt").textContent = new Date(
              data.updated_at
            ).toLocaleString();

            // 更新当前阶段
            currentStage = data.status;

            // 更新进度条
            updateProgressBar(data.status);

            // 检查是否需要用户审批
            if (data.status.startsWith("waiting_user_approval_")) {
              // 停止轮询
              clearInterval(statusTimer);

              // 显示预览区域
              document
                .getElementById("previewSection")
                .classList.remove("hidden");

              // 获取需要审批的内容
              const approvalStage = data.status.replace(
                "waiting_user_approval_",
                ""
              );
              await getApprovalContent(approvalStage);
            }

            // 检查是否已完成
            if (data.status === "completed") {
              // 停止轮询
              clearInterval(statusTimer);

              // 获取最终结果
              await getVideoResult();
            }
          } else {
            console.error("获取状态失败：", data.message);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // 更新进度条
      function updateProgressBar(status) {
        let progress = 0;

        // 根据状态设置进度
        if (status === "initialization") {
          progress = 5;
        } else if (status === "script_creation") {
          progress = 15;
        } else if (status.includes("script")) {
          progress = 25;
        } else if (status === "video_generation") {
          progress = 35;
        } else if (status.includes("video")) {
          progress = 45;
        } else if (status === "audio_generation") {
          progress = 55;
        } else if (status.includes("audio")) {
          progress = 65;
        } else if (status === "post_production") {
          progress = 75;
        } else if (status.includes("final_video")) {
          progress = 85;
        } else if (status === "distribution") {
          progress = 95;
        } else if (status === "completed") {
          progress = 100;
        }

        // 更新进度条
        const progressBar = document.getElementById("progressBar");
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute("aria-valuenow", progress);
        progressBar.textContent = `${progress}%`;
      }

      // 获取需要审批的内容
      async function getApprovalContent(stage) {
        // 在实际项目中，这里应该从API获取需要审批的内容
        // 目前使用模拟数据

        let previewHtml = "";

        if (stage === "script") {
          previewHtml = `
                    <h4>脚本预览</h4>
                    <div class="preview-item">
                        <h5>标题：示例视频脚本</h5>
                        <p><strong>主题：</strong>${
                          document.getElementById("theme").value
                        }</p>
                        <p><strong>类型：</strong>${
                          document.getElementById("scriptType").value
                        }</p>
                        <p><strong>片段1：</strong>这是第一个场景的示例内容...</p>
                        <p><strong>片段2：</strong>这是第二个场景的示例内容...</p>
                    </div>
                `;
        } else if (stage === "video") {
          previewHtml = `
                    <h4>视频预览</h4>
                    <div class="preview-item">
                        <p>视频预览（实际项目中应该显示视频预览）</p>
                        <div class="ratio ratio-16x9">
                            <div class="bg-secondary d-flex align-items-center justify-content-center">
                                <p class="text-white">视频预览区域</p>
                            </div>
                        </div>
                    </div>
                `;
        } else if (stage === "audio") {
          previewHtml = `
                    <h4>音频预览</h4>
                    <div class="preview-item">
                        <p>音频预览（实际项目中应该显示音频播放器）</p>
                        <div class="bg-secondary p-3 text-white">
                            音频播放控件
                        </div>
                    </div>
                `;
        } else if (stage === "final_video") {
          previewHtml = `
                    <h4>最终视频预览</h4>
                    <div class="preview-item">
                        <p>最终视频预览（实际项目中应该显示视频预览）</p>
                        <div class="ratio ratio-16x9">
                            <div class="bg-secondary d-flex align-items-center justify-content-center">
                                <p class="text-white">最终视频预览区域</p>
                            </div>
                        </div>
                    </div>
                `;
        }

        document.getElementById("previewContent").innerHTML = previewHtml;
      }

      // 获取最终视频结果
      async function getVideoResult() {
        try {
          const response = await fetch(
            `${API_BASE_URL}/videos/result/${currentSessionId}`
          );
          const data = await response.json();

          if (data.success && data.status === "completed") {
            // 显示结果区域
            document.getElementById("resultSection").classList.remove("hidden");

            // 更新结果显示
            const video = data.video;
            const resultHtml = `
                        <h4>${video.title}</h4>
                        <div class="ratio ratio-16x9 mb-3">
                            <div class="bg-secondary d-flex align-items-center justify-content-center">
                                <p class="text-white">视频播放区域（实际项目中应该显示视频播放器）</p>
                            </div>
                        </div>
                        <p><strong>视频ID：</strong>${video.id}</p>
                        <p><strong>时长：</strong>${video.duration}秒</p>
                        <p><strong>创建时间：</strong>${new Date(
                          video.created_at
                        ).toLocaleString()}</p>
                        <a href="${
                          video.url
                        }" class="btn btn-primary" target="_blank">查看视频</a>
                        <a href="#" class="btn btn-secondary" onclick="resetForm()">创建新视频</a>
                    `;

            document.getElementById("videoResult").innerHTML = resultHtml;
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // 批准按钮点击处理
      document
        .getElementById("approveBtn")
        .addEventListener("click", function () {
          submitUserResponse("approve");
        });

      // 拒绝按钮点击处理
      document
        .getElementById("rejectBtn")
        .addEventListener("click", function () {
          submitUserResponse("reject");
        });

      // 提交用户响应
      async function submitUserResponse(choice) {
        const feedback = document.getElementById("feedbackText").value;

        try {
          const response = await fetch(
            `${API_BASE_URL}/videos/user-response/${currentSessionId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                choice: choice,
                feedback: feedback,
              }),
            }
          );

          const data = await response.json();

          if (data.success) {
            // 隐藏预览区域
            document.getElementById("previewSection").classList.add("hidden");

            // 重新开始轮询状态
            startStatusPolling();
          } else {
            alert("提交响应失败：" + data.message);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("提交响应请求失败，请查看控制台了解详情");
        }
      }

      // 取消按钮点击处理
      document
        .getElementById("cancelBtn")
        .addEventListener("click", async function () {
          if (!currentSessionId) return;

          if (!confirm("确定要取消视频生成吗？")) return;

          try {
            const response = await fetch(
              `${API_BASE_URL}/videos/${currentSessionId}`,
              {
                method: "DELETE",
              }
            );

            const data = await response.json();

            if (data.success) {
              alert("视频生成已取消");
              resetForm();
            } else {
              alert("取消失败：" + data.message);
            }
          } catch (error) {
            console.error("Error:", error);
            alert("取消请求失败，请查看控制台了解详情");
          }
        });

      // 刷新状态按钮点击处理
      document
        .getElementById("refreshBtn")
        .addEventListener("click", function () {
          getVideoStatus();
        });

      // 重置表单
      function resetForm() {
        // 清除会话ID
        currentSessionId = null;

        // 清除定时器
        if (statusTimer) {
          clearInterval(statusTimer);
          statusTimer = null;
        }

        // 重置表单
        document.getElementById("videoForm").reset();

        // 显示创建表单，隐藏其他区域
        document.getElementById("createForm").classList.remove("hidden");
        document.getElementById("statusSection").classList.add("hidden");
        document.getElementById("previewSection").classList.add("hidden");
        document.getElementById("resultSection").classList.add("hidden");
      }
    </script>
  </body>
</html>
