# TikTok 风格短视频多代理协作生成系统 - 项目文档

## 1. 项目概述

本系统是一个多代理协作框架，旨在通过用户可选的视频生成模型和音频工具，生成高质量的 TikTok 风格短视频。系统由六个专门的代理组成，每个代理负责视频创作过程中的一个特定环节，并通过标准化通信协议协作。

### 1.1 系统架构

系统由六个专门的代理组成：

1. **中央策略代理** - 系统的"导演"，负责全局协调与决策
2. **内容创作代理** - 系统的"编剧"，生成短视频脚本
3. **视觉生成代理** - 系统的"摄影师"，生成视频片段
4. **语音与音乐代理** - 系统的"音频导演"，生成旁白和背景音乐
5. **后期制作代理** - 系统的"编辑"，整合视频、音频和字幕
6. **分发代理** - 系统的"营销专家"，优化发布和分析表现

### 1.2 主要特性

- 支持多种视频生成模型：可灵、Pika、Runway、Wan 2.1 等
- 支持多种语音合成工具：ElevenLabs、Play.ht 等
- 支持多种音乐生成工具：Suno AI、AIVA 等
- 用户可在关键创作阶段进行选择和干预
- 完整的质量保证与可观测性功能

## 2. 系统组件详解

### 2.1 代理组件

#### 2.1.1 中央策略代理 (CentralAgent)

中央策略代理是系统的核心，负责协调整个视频创作流程。它接收用户输入，创建工作流会话，并将任务分配给其他专门代理。它还负责收集用户反馈并做出相应调整。

**主要功能**：

- 创建和管理工作流会话
- 协调其他代理的工作
- 处理用户反馈和干预
- 监控整个创作过程

#### 2.1.2 内容创作代理 (ContentAgent)

内容创作代理负责生成视频脚本。它使用 OpenAI API 或其他 LLM 来创建引人入胜的脚本内容，包括场景描述、对话和旁白。

**主要功能**：

- 生成视频脚本
- 根据用户反馈修改脚本
- 分析热门趋势，优化内容

#### 2.1.3 视觉生成代理 (VisualAgent)

视觉生成代理负责将脚本转化为视频片段。它支持多种视频生成模型，如可灵、Pika、Runway 和 Wan 2.1，用户可以根据需求选择最适合的模型。

**主要功能**：

- 生成视频片段
- 评估视频质量
- 支持多种视频生成模型

#### 2.1.4 语音与音乐代理 (AudioAgent)

语音与音乐代理负责生成旁白和背景音乐。它支持多种语音合成工具和音乐生成工具，可以创建与视频内容匹配的高质量音频。

**主要功能**：

- 生成语音旁白
- 创建背景音乐
- 支持多种语音和音乐工具

#### 2.1.5 后期制作代理 (PostProdAgent)

后期制作代理负责将视频片段、语音和音乐整合为最终成品。它处理剪辑、转场、字幕和特效等后期制作工作。

**主要功能**：

- 整合视频和音频
- 添加字幕和特效
- 生成最终视频

#### 2.1.6 分发代理 (DistributionAgent)

分发代理负责优化视频元数据并准备发布。它分析热门趋势，优化标题、描述和标签，以提高视频的曝光率。

**主要功能**：

- 优化视频元数据
- 分析热门趋势
- 监控视频表现

### 2.2 通信机制

代理之间通过消息总线（MessageBus）进行通信。消息总线实现了发布-订阅模式，允许代理异步发送和接收消息。

**消息类型**：

- 命令消息 (COMMAND)：请求执行特定操作
- 响应消息 (RESPONSE)：操作执行结果
- 数据消息 (DATA)：传输数据
- 错误消息 (ERROR)：报告错误
- 状态消息 (STATUS)：更新状态
- 问题消息 (QUESTION)：询问用户

### 2.3 数据模型

系统使用以下主要数据模型：

- **Message**：代理间通信的消息
- **Script**：视频脚本，包含多个场景
- **VideoAsset**：视频资产，对应脚本中的一个场景
- **AudioAsset**：音频资产，包括语音和音乐
- **FinalVideo**：最终生成的视频
- **WorkflowState**：工作流状态，记录整个创作过程

### 2.4 工具类

系统包含以下主要工具类：

- **MessageBus**：消息总线，处理代理间通信
- **FileManager**：文件管理器，处理文件的保存、移动和删除
- **Logger**：日志工具，记录系统运行日志

## 3. 工作流程

系统的工作流程如下：

1. **初始化**：用户提供主题、风格偏好，并选择视频生成模型和音频工具。
2. **脚本创建**：内容创作代理生成脚本，用户可以预览和修改。
3. **视频生成**：视觉生成代理使用选定的模型生成视频片段，用户可以预览和选择。
4. **音频生成**：语音与音乐代理生成旁白和背景音乐，用户可以预览和选择。
5. **后期制作**：后期制作代理整合视频和音频，添加字幕和特效，用户可以预览最终结果。
6. **分发**：分发代理优化元数据，准备发布。

在每个关键阶段，系统都会请求用户审批，用户可以选择批准或拒绝，并提供反馈意见。

## 4. API 接口

系统提供以下主要 API 接口：

- **POST /api/videos/create**：创建新视频
- **GET /api/videos/status/{session_id}**：获取视频创建状态
- **POST /api/videos/user-response/{session_id}**：提交用户响应
- **GET /api/videos/result/{session_id}**：获取视频创建结果
- **DELETE /api/videos/{session_id}**：取消视频创建
- **GET /api/trending-topics**：获取热门话题

## 5. 配置与扩展

### 5.1 配置文件

系统使用以下配置文件：

- **.env**：环境变量配置，包括 API 密钥和系统参数
- **config/config.py**：系统配置，包括模型和工具配置

### 5.2 扩展新模型或工具

要添加新的视频生成模型或音频工具，需要：

1. 在配置文件中添加新模型/工具的定义
2. 在相应的代理中实现 API 接口
3. 更新前端界面，添加新选项

## 6. 部署与运行

### 6.1 环境要求

- Python 3.8+
- 依赖包：见 requirements.txt

### 6.2 安装步骤

1. 克隆代码库
2. 安装依赖：`pip install -r requirements.txt`
3. 复制.env.example 为.env 并填写 API 密钥
4. 运行初始化脚本：`python init.py`

### 6.3 运行系统

1. 启动后端服务：`python main.py`
2. 启动前端服务：`python ui/server.py`
3. 在浏览器中访问：`http://localhost:8080`

## 7. 开发指南

### 7.1 代码结构

```
project/
├── agents/                 # 代理实现
│   ├── base_agent.py       # 代理基类
│   ├── central_agent.py    # 中央策略代理
│   ├── content_agent.py    # 内容创作代理
│   ├── visual_agent.py     # 视觉生成代理
│   ├── audio_agent.py      # 语音与音乐代理
│   ├── postprod_agent.py   # 后期制作代理
│   └── distribution_agent.py # 分发代理
├── api/                    # API接口
├── config/                 # 配置文件
│   └── config.py           # 系统配置
├── models/                 # 数据模型
│   ├── message.py          # 消息模型
│   ├── video.py            # 视频相关模型
│   └── user.py             # 用户相关模型
├── services/               # 服务实现
├── tests/                  # 测试代码
├── ui/                     # 前端界面
│   ├── index.html          # 主页面
│   └── server.py           # 前端服务器
├── utils/                  # 工具类
│   ├── message_bus.py      # 消息总线
│   ├── logger.py           # 日志工具
│   └── file_manager.py     # 文件管理器
├── .env.example            # 环境变量示例
├── init.py                 # 初始化脚本
├── main.py                 # 主程序入口
└── requirements.txt        # 依赖包列表
```

### 7.2 开发流程

1. 创建功能分支
2. 实现功能并编写测试
3. 提交代码并创建合并请求
4. 代码审查和合并

### 7.3 测试

系统使用 pytest 进行测试。运行测试：

```bash
pytest
```

## 8. 故障排除

### 8.1 常见问题

- **API 密钥错误**：检查.env 文件中的 API 密钥是否正确
- **模型不可用**：检查所选模型的 API 是否可用
- **文件权限问题**：确保 temp 和 output 目录有写入权限

### 8.2 日志文件

系统日志位于 logs 目录下：

- **system.log**：系统级日志
- **central\_\*.log**：中央代理日志
- **content\_\*.log**：内容代理日志
- **visual\_\*.log**：视觉代理日志
- **audio\_\*.log**：音频代理日志
- **postprod\_\*.log**：后期制作代理日志
- **distribution\_\*.log**：分发代理日志

## 9. 许可证

本项目采用 MIT 许可证。详见 LICENSE 文件。
